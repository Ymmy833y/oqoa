# ğŸ” 7. ä¸»è¦æ©Ÿèƒ½ãƒ•ãƒ­ãƒ¼

## æ¼”ç¿’ãƒ•ãƒ­ãƒ¼
1. å•é¡Œé›†ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã—ã€`Effect.PREPARE_PRACTICE_START` ã‚’å®Ÿè¡Œ
2. æ¼”ç¿’é–‹å§‹æ™‚ã« `practice_sevice.generatePracticeDetailDto` ã§å‡ºé¡Œã‚’ç”Ÿæˆ
3. å›ç­”ç¢ºå®šã§ `ans_history_service.insertAnsHistory` ã‚’å‘¼ã³ã€å±¥æ­´ã‚’ä¿å­˜
4. å…¨å•å›ç­”å¾Œã« `practice_sevice.doPracticeComplete` ã§å®Œäº†çŠ¶æ…‹ã¸

å‚ç…§: `src/app/services/practice_sevice.ts:20-120`

## æ¤œç´¢ãƒ•ãƒ­ãƒ¼
- è¨­å•æ¤œç´¢ã¯ `question_service.selectQuestionsForSearchForm` ã§æ¡ä»¶ã‚’é©ç”¨
- ãŠæ°—ã«å…¥ã‚Š/æœŸé–“/æ­£ç­”ç‡ã®æ¡ä»¶ã‚’çµ„ã¿åˆã‚ã›ã¦æŠ½å‡º

å‚ç…§: `src/app/services/question_service.ts:10-151`

## å±¥æ­´ãƒ•ãƒ­ãƒ¼
- æ¼”ç¿’å±¥æ­´ã¯ `practice_sevice.selectPracticeHistoryDtos` ã§å–å¾—
- è¨­å•å±¥æ­´ã¯ `ans_history_service.selectAnsHistoryDtos` ã§å–å¾—

å‚ç…§: `src/app/services/ans_history_service.ts:79-117`

## ãŠæ°—ã«å…¥ã‚Šãƒ•ãƒ­ãƒ¼
- ãŠæ°—ã«å…¥ã‚Šã®è¿½åŠ /å‰Šé™¤ã¯ `favorite_service.upsertFavorite` ã§ç®¡ç†

å‚ç…§: `src/app/services/favorite_service.ts:5-31`

## å›ç­”ç™»éŒ²ã®æµã‚Œ
```mermaid
sequenceDiagram
  participant User as User
  participant View as View
  participant Controller as Controller
  participant Update as Update
  participant Service as AnsHistoryService
  participant Repo as AnsHistoryRepository
  User->>View: å›ç­”
  View->>Controller: PRACTICE_ANSWERED
  Controller->>Update: Action
  Update-->>Controller: Effect.PRACTICE_ANSWERED
  Controller->>Service: insertAnsHistory(...)
  Service->>Repo: insert(...)
  Service-->>Controller: updated PracticeDetailDto
  Controller->>View: render
```

## é–¢é€£ãƒªãƒ³ã‚¯
- æ°¸ç¶šåŒ–ã®è©³ç´°ã¯ [æ°¸ç¶šåŒ–ã¨ãƒªãƒã‚¸ãƒˆãƒª](./06-æ°¸ç¶šåŒ–ã¨ãƒªãƒã‚¸ãƒˆãƒª.md) ã‚’å‚ç…§

## ğŸ” å‚ç…§ã‚³ãƒ¼ãƒ‰
å‚ç…§: `src/app/services/ans_history_service.ts:16-42`ï¼ˆã‚³ãƒ¡ãƒ³ãƒˆã¯èª¬æ˜ç”¨ã«è¿½è¨˜ï¼‰

```ts
// NOTE: å›ç­”ã‚’å±¥æ­´ã¨ã—ã¦ä¿å­˜ã—ã€DTO ã‚’æ›´æ–°ã™ã‚‹
export async function insertAnsHistory(
  practiceDetailDto: PracticeDetailDto,
  practiceHistoryId: number,
  questionId: number,
  isCorrect: boolean,
  selectChoice: number[],
): Promise<PracticeDetailDto> {
  const ansHistory = AnsHistory.fromRequiredArgs(
    practiceHistoryId,
    questionId,
    isCorrect,
    selectChoice,
    new Date().toISOString(),
  );
  const ansHistoryId = await ansHistoryRepository.insert(
    ansHistory.generateRow(),
  );
  ansHistory.setId(ansHistoryId);
```
